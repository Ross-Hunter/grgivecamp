<?php

function grgivecamp_custom_block($op = 'list', $delta = '', $edit = array()) {
  // The $op parameter determines what piece of information is being requested.
  switch ($op) {
    case 'list':
      // If $op is "list", we just need to return a list of block descriptions.
      // This is used to provide a list of possible blocks to the administrator;
      // end users will not see these descriptions.
      $blocks['statistics'] = array(
        'info'       => t('GR Givecamp Statistics'),
      );
      return $blocks;
    case 'view':
      // If $op is "view", then we need to generate the block for display
      // purposes. The $delta parameter tells us which block is being requested.
      switch ($delta) {
        case 'statistics':
          // The subject is displayed at the top of the block. Note that it
          // should be passed through t() for translation.
          $block['subject'] = t('GR Givecamp Statistics');
          // The content of the block is typically generated by calling a custom
          // function.
          $block['content'] = grgivecamp_custom_statistics_block();
          break;
      }
      return $block;
  }
}

function grgivecamp_custom_statistics_block(){
  $content = '';
  $content .= '<div class="stats">';
  $content .= '<h5>Non-Profit Applications</h5>';
  // $content .= '<p>' . grgivecamp_custom_non_profit_submissions()->count . '<a href="/non-profits" class="sign-up-button">Register Now!</a>';
  $content .= '<p>' . grgivecamp_custom_non_profit_submissions()->count . '</p>';
  $content .= '</div>';

  $content .= '<div class="stats">';
  $content .= '<h5>Volunteer Applications</h5>';
  $content .= '<p>' . grgivecamp_custom_total_volunteers() . '<a href="/get-involved" class="sign-up-button">Register Now!</a>';

  $content .= '</div>';

  $content .= '<div class="stats">';
  $content .= '<h5>Estimated Value To Local Non-Profits</h5>';
  $content .= '<p>' . grgivecamp_custom_total_value() . '</p>';
  $content .= '</div>';

  return $content;
}

function grgivecamp_custom_total_value() {
  $HOURLY_RATE = 100.00;
  // $TOTAL_HOURS = 48;
  $TOTAL_HOURS = 24; // A more realistic estimate

  $amount = "\$" . number_format(grgivecamp_custom_total_volunteers() * $HOURLY_RATE * $TOTAL_HOURS, 2);
  return $amount;
}

function grgivecamp_custom_total_volunteers() {
  $tech_count = grgivecamp_custom_technical_volunteer_submissions()->count;
  $non_tech_count = grgivecamp_custom_non_technical_volunteer_submissions()->count;

  return ($tech_count + $non_tech_count);
}

// Right now these are just passing in the nid of the corresponding form

function grgivecamp_custom_non_profit_submissions() {
  return grgivecamp_custom_submissions_count(76);
}

function grgivecamp_custom_non_technical_volunteer_submissions() {
  return grgivecamp_custom_submissions_count(75);
}

function grgivecamp_custom_technical_volunteer_submissions() {
  return grgivecamp_custom_submissions_count(74);
}

function grgivecamp_custom_submissions_count($nid) {
  $query = 'SELECT nid, COUNT(*) AS count FROM {webform_submissions} WHERE nid = %d';
  $result = db_query($query, $nid);
  return db_fetch_object($result);
}